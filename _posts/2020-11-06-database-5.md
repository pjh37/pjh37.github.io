---
layout: post
title:  " MYSQL 아키텍처"
date:   2020-11-06
desc: "Mysql의 기본구조"
keywords: "database"
categories: [Database]
tags: [Database]
icon: icon-html
---

MySQL
====

![mysql구조](https://user-images.githubusercontent.com/37110261/98378142-fc920080-2088-11eb-8b76-a731555e5c0b.png)

<br/>

MySQL 엔진
----
### MySQL 엔진은 클라이언트로부터의 접속 및 쿼리요청을 처리하는 커넥션 핸들러와 SQL파서 및 전처리기 그리고 쿼리의 최적화된 실행을 위한 옵티마이저가 중심을 이룬다.
### 성능향상을 위해 MylSAM의 키캐시나 InnoDB의 버퍼풀같은 보조 저장소 기능이 포함되 있다.

<br/>

스토리지 엔진
----
### MySQL 엔진은 요청된 SQL문장을 분석하거나 최적화하는 등 DBMS의 두뇌에 해당하는 처리를 수행하고 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분은 스토리지 엔진이 전담한다. MySQL 서버에서 MySQL 엔진은 하나지만 스토리지 엔진은 여러 개를 동시에 사용할 수 있다. 

``` sql
create table test_table(fb1 INT,fd2 INT) ENGINE=INNODB;
```

<br/>

MySQL 스레딩 구조
----
### MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동하며, 크게 포그라운드 스레드와 백그라운드 스레드로 구분할 수 있다.

<br/>

## 포그라운드 스레드(클라이언트 스레드)
### 포그라운드 스레드는 최소한 MySQL 서버에 접속된 클라이언트의 수만큼 존재하며, 주로 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리하는 것이 임무다. 클라이언트 사용자가 작업을 마치고 커넥션을 종료하면, 해당 커넥션을 담당하던 스레드는 다시 Thread pool로 되돌아간다. 이때 이미 스레드 풀에 일정 개수 이상의 대기중인 스레드가 있으면 스레드 풀에 넣지 않고 스레드를 종료시켜 일정 개수의 스레드만 스레드 풀에 존재하게 된다. 이렇게 스레드의 개수를 일정하게 유지하게 만들어주는 파라미터가 thread_cache_size다.

<br/>

### 포그라운드 스레드는 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져오며, 버퍼나 캐시에 업는 경우에는 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 작업을 처리한다. MylSAM테이블은 디스크 쓰기 작업까지 포그라운드 스레드가 처리하지만 InnoDB테이블은 데이터 버퍼나 캐시까지만 포그라운드 스레드가 처리하고 나머지 버퍼로부터 디스크까지 기록하는 작업은 백그라운드 스레드가 처리한다.


<br/>

## 백그라운드 스레드
### MylSAM의 경우에는 별로 해당 사항이 없지만 InnoDB는 여러 가지 작업이 백그라운드로 처리된다.
+ ### 인서트 버퍼를 병합하는 스레드
+ ### 로그를 디스크로 기록하는 스레드
+ ### InnoDB버퍼 풀의 데이터를 디스크에 기록하는 스레드
+ ### 데이터를 버퍼로 읽어들이는 스레드
+ ### 잠금이나 데드락을 모니터링하는 스레드
+ ### 이러한 모든 스레드를 총괄하는 메인스레드

<br/>

### 가장 중요한 것은 로그 스레드와 버퍼의 데이터를 디스크로 내려쓰는 작업을 하는 쓰기 스레드이다. 
+ ### 쓰기 스레드는 innodb_write_io_thrads
+ ### 읽기 스레드는 innodb_read_io_threads 를 통해 지정해줄 수 있다.
### 데이터를 읽는 작업은 주로 클라이언트 스레드에서 처리되기 때문에 읽기 스레드는 많이 설정할 필요가 없지만 쓰기 스레드는 아주 많은 작업을 백그라운드로 처리하기 때문에 일반적인 내장 디스크를 사용할 때는 2~4정도 설정한다.
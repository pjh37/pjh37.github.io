---
layout: post
title:  " [MYSQL] 쿼리별 잠금"
date:   2022-10-06
desc: "쿼리별 잠금 정책"
keywords: "database"
categories: [Database]
tags: [Database]
icon: icon-html
---

<br/>

## MySQL 잠금

### InnoDB 기본잠금

+ SELECT
```mysql
select * from employees where emp_no=100 lock in share mode;
select * from employees where emp_no=100 for update ;
```

select 쿼리로 읽은 레코드를 잠그는 방법
+ 읽기모드
+ 쓰기모드

## LOCK IN SHARE MODE
+ 읽기 잠금만 걸기 때문에 잠금을 획득한 트랜잭션에서 변경할려면 쓰기 잠금을 다시 획득해야 한다.
+ 다시 쓰기 잠금을 획득한다 -> 쓰기 잠금을 획득하기위해 기다려야할 수 도 있음
+ 읽기 잠금을 가진 상태에서 다시 쓰기 잠금을 획득해야하는 상황은 데드락을 유발하는 가장 일반적인 형태

## FOR UPDATE
+ 읽은 후 변경도 해야한다면 for update 는 select후 쓰기 모드로 잠근다.

<br/>

### 두 가지 잠금의 특징
Lock in share mode, for update같은 잠금 읽기 기능은 commit이나 rollback이 실행되면 잠금이 해제되므로 반드시 하나의 트랜잭션 에서만 유효하다

<br/>

## INSERT,UPDATE,DELETE
+ 기본적으로 쓰기 잠금 획득
+ InnoDB에서 Update,Delete문장을 실행할때 SQL문장이 조건에 일치하는 레코드를 찾기 위해 참조(스캔)하는 인덱스의 모든 레코드를 잠근다.
+ 쿼리 문장에서 Where조건에 일치하지 않는 레코드도 잠금의 대상이 될 수 있다.

```mysql
update student set last_name='...' where first_name="홍길동" and gender="M";
index -> ix_first_name으로 걸려 있음
```

| id  | first_name | last_name | gender |
|-----|------------|-----------|--------|
| 1   | hong       | boo       | F      |
| 2   | hong       | boo       | F      |
| 3   | hong       | boo       | F      |
| 4   | hong       | Foo       | M      |
| 5   | hong       | Foo       | M      |
| 6   | hong       | Foo       | M      |

+ 위와 같은 테이블에서 해당 Update 쿼리를 날렸을 경우 first_name조건 때문에 1~6번 레코드 전체에 잠금이 걸리게 되지만
실제 변경되는 레코드는 4~6번이다. 이처럼 실제 쿼리가 반영되는 레코드와 잠금이 걸리게 되는 레코드가 차이가 날 수 있다.
+ 작은 테이블이라고 인덱스 생성하지 않을때도 있는데 update,delete문장의 조건의 컬럼이 있다면 꼭 인덱스를 생성하라
+ 만약에 인덱스가 걸려있지 않다면 테이블의 모든 레코드에 잠금을 걸어버리기 때문에 주의해야 한다.

<br/>

## SQL 문장별 잠금
+ select ... from ...
  + 별도의 잠금을 걸지 않음
+ select ... from ... lock in share mode
  + where절에 일치하는 레코드뿐만 아니라 검색을 위해 접근한 모든 레코드에 공유 넥스트 키락을 건다.
  + 만약 읽기 잠금을 걸어야 하는 레코드가 다른 트랜잭션에 의해 쓰기 잠금에 걸려 있다면 그 잠금이 해제될때까지 기다려야 한다.
  + 다른 트랜잭션에 의해 읽기 잠금이 걸려 있다면 읽기 잠금끼리는 상호 호환이 되므로 별도의 대기 없이 읽기 잠금을 획득할 수 있다.
+ select ... from ... for update
  + for update옵션이 사용된 select 쿼리 문장도 where조건절에 일치하는 레코드를 검색하기 위해 접근한 모든 레코드에 대해 베타적 넥스트 키락을 건다.
  + 대상 레코드가 다른 트랜잭션에 의해 읽기 잠금이나 쓰기 잠금이 걸려 있다면 반드시 그 잠금이 해제될 때까지 대기 해야한다.
  + for update가 사용되면 일관된 읽기가 무시된다.

### 잠금간의 호환성

| 종류    | 읽기 잠금 | 쓰기 잠금 |
|-------|-------|-------|
| 읽기 잠금 | O     | X     |
| 쓰기 잠금 | X     | X     |